# Доменные правила

## Термины

- **Контекст** — обязательная область для любого логирования.
- **Тег** — глобальная метка пользователя.
- **Цель** — правило на период (день/неделя/месяц) с целевым значением и направлением.
- **События** — фактические действия пользователя:
  - Time entry (time)
  - Counter event (counter)
  - Check event (check)
- **Goal period** — кеш прогресса и статуса по каждому периоду цели.

## Инварианты данных

- У всех событий обязателен `context_id`.
- `goal_id` для событий опционален.
- Теги опциональны, не привязаны к контексту.
- У цели всегда есть контекст.
- `start_date <= end_date`.
- Для time entry: `ended_at` либо `NULL`, либо `>= started_at`.
- В приложении допускается только одна активная (не завершённая) time entry на пользователя.

## Семантика целей

Цель определяется:

- `goal_type`: `time | counter | check`
- `period`: `day | week | month`
- `target_value`
- `target_op`: `gte` (>=) или `lte` (<=)

**Позитивная цель** — `gte`, **негативная цель** — `lte`.

## Периоды и таймзона

Границы периодов рассчитываются на клиенте в локальной таймзоне:

- Day: 00:00 – 24:00
- Week: ISO-неделя (пн–вс)
- Month: календарный месяц

## Подсчёт факта (actual_value)

- **Time**: сумма длительностей time entries в пределах периода.
- **Counter**: сумма `value_delta` за период.
- **Check**: последнее событие в периоде определяет состояние (1 или 0).

## Определение статуса

Статус хранится в `goal_periods.status` и определяется логикой пересчёта:

1. Если цель архивирована — `archived`.
2. Для `gte`:
   - `success`, если `actual_value >= target_value`.
   - иначе `in_progress`, если период ещё не завершён, или `fail`, если завершён.
3. Для `lte`:
   - `fail`, если `actual_value > target_value`.
   - иначе `in_progress`, если период ещё не завершён, или `success`, если завершён.
